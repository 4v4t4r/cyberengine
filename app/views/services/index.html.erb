<% if can?(:new, Service) %>
  <% content_for :actions do %>
    <% if can? :new, Service %>
      <li class="new"> 
        <%= link_to new_team_server_service_path(@team,@server) do %>New Service<i class="icon-plus-sign"></i><% end %>
      </li>
    <% end %>  
  <% end %>  
<% end %> 

<% content_for :paths do %>
  <li class='path'>
    <%= link_to teams_path do %><span>Teams</span><i class="icon-chevron-left"></i><% end %>
  </li>
  <li class='path indent'>
    <%= link_to team_path(@team) do %><span><%= @team.alias %></span><i class="icon-chevron-left"></i><% end %>
  </li>
  <li class='path'>
    <%= link_to team_servers_path(@team) do %><span>Servers</span><i class="icon-chevron-left"></i><% end %>
  </li>
  <li class='path indent'>
    <%= link_to team_server_path(@team,@server) do %><span><%= @server.name %></span><i class="icon-chevron-left"></i><% end %>
  </li>
  <li class='path'>
    <%= link_to team_server_services_path(@team,@server) do %><span>Services</span><i class="icon-chevron-left"></i><% end %>
  </li>
<% end %>


<div class="page-header">
  <h3>Services</h3>
</div>

<% services = @server.services.order("version,protocol DESC") %>
<table class="table table-bordered table-hover">
  <thead>
    <tr>
      <th>Service</th>
      <th>Version</th>
      <th>Protocol</th>
      <th>Status</th>
      <th>Checks</th>
      <th>Users</th>
      <th>Properties</th>
    </tr>
  </thead>
  <tbody>
    <% services.each do |service| %>
      <% next if cannot? :show, service %>
      <% latest = service.checks.latest || Check.new %>
      <% label_class = latest.passed ? "success" : "important" %>
      <% label_text = latest.passed ? "Passed" : "Failed" %>
      <tr>
        <td><%= link_to service.name, team_server_service_path(@team,@server,service) %></td>
        <td><%= service.version %></td>
        <td><%= service.protocol %></td>
        <td>
          <% if latest.id.nil? %>
            <span class="label label-info">No Checks</span>
          <% else %>
            <%= link_to modal_team_server_service_check_path(@team,@server,service,latest), data: { toggle: "modal", target: "#checksModal" } do %>
              <span class="label label-<%= label_class %>"><%= label_text %></span>
            <% end %>
          <% end %>
        </td>
        <td>
          <% if service.checks.count == 0 %>
            No Checks
          <% else %>
            <%= link_to "Checks", team_server_service_checks_path(@team,@server,service) %>
          <% end %>
        </td>
        <td>
          <% if service.users.count == 0 %>
            No Users
          <% else %>
            <%= link_to "Users", modal_team_server_service_users_path(@team,@server,service), data: { toggle: "modal", target: "#usersModal" } %>
          <% end %>
        </td>
        <td>
          <% if service.properties.count == 0 %>
            No Properties
          <% else %>
            <%= link_to "Properties", modal_team_server_service_properties_path(@team,@server,service), data: { toggle: "modal", target: "#propertiesModal" } %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<%= render partial: 'checks/modal' %>
<%= render partial: 'properties/modal' %>
<%= render partial: 'users/modal' %>
